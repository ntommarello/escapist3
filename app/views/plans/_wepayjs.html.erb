<div id="Payment" style="display:none">
	<p class="HighlightedTitle" style="text-align:center">Purchase Tickets</p>
	<div class="price_display" style="float:left; width:100px; font-weight:bold; color:black; font-size:22px;">$<%=plan.price%></div>

	<div class="SubTitle" style="float:left; width:270px;margin-left: 10px; font-weight:normal; padding-bottom:10px"><%=raw plan.title%></div>
	<div style="clear:both"></div>
	<select id="qty" class="qty" onchange="qty=$(this).val(); price=$('#unit_price').val()*qty; $('.price_display').html('$'+roundNumber($('#unit_price').val()*$(this).val(),2)); $('.qty').val($(this).val()); ">
		<option value="1">1 ticket</option>
		<option value="2">2</option>
		<option value="3">3</option>
		<option value="4">4</option>
		
	</select>
	
	<div style="clear:both; height:15px;"></div>
	<span class="SubTitle" style="font-weight:normal; font-size:12px;"><b>Refund Policy</b>:  100% refund if requested, for any reason.</span>
	
	<div class="rewardlink" style="font-weight:normal" onclick="$('.rewardlink').hide(); $('.RewardDiv').show(); $('.RewardCode').focus();"><a href="#"  class="BlueLink">Have a reward code?</a></div>
	<div class="RewardDiv" style="display:none">
		<input class="RewardCode" type="textfield" style="font-size:12px;">
		<input type="button" style="" value="apply" onclick="ApplyReward($('.RewardCode',$(this).parent()).val())">
	</div>
</div>



<SCRIPT>
plan_id=<%=plan.id%>
qty=1;
price=<%=plan.price%>;




function roundNumber(num, dec) {
	var result = Math.round(num*Math.pow(10,dec))/Math.pow(10,dec);
	result  = result.toFixed(2);
	return result;
}


function payBill() {
 	
	txt = $("#Payment").html();

	txt2 = '<p class="HighlightedTitle" style="text-align:center">One Moment Please</p><div style="padding-top:5px" align="center"><img src="/images/ajax-loader-bar.gif"</div>'
	
	    var temp = {
	        state0: {
	            html: txt,
	            buttons: { Cancel: false, Checkout: true },
				persistent:false,
	            focus: 1,
				submit: function(v, m, f) {
			         if (v == 0) {
						$.prompt.close();
							return false;
					} else {
						
						if (price <1) {
							
							signUpFree(plan_id)
							
						} else {
						
							createBill();
						
						}
		  				$.prompt.goToState('state1');
						
						return false;
					}
	            }
	        },
	        state1: {
	            html: txt2,
	            buttons: { Close: 0 },
	            focus: 0,
	            submit: function(v, m, f) {
	                if (v === 0) {
	                    $.prompt.close();
		return false;
	                }
	            }
	        }
	    };
	    $.prompt(temp);
}

function createBill() {
	$.getJSON("https://www.wepay.com/sp/create?format=jsonp&callback=?",
         {  token: "a8a520ec65", 
            group_id: "11377",
            buyer_email: "<%if current_user%><%=current_user.email%><%end%>",
            amount: price,
			fee_payer: "recipient",
			ref_id: "<%=plan.id%>",
			message: "<%=plan.start_time.strftime('%A, %B %e at %l:%M%p')%>",
			silent: 0,
			<%if current_user%>
				rd: "http://<%=APP_URL%>/confirmation?plan_id=<%=plan.id%>&user_id=<%=current_user.id%>",
			<%end%>
            reason: "<%=plan.title%> (x"+qty+")"
         } ,function(data) {
            window.location.href=data.result;
         });
}


$(document).ready(function() {
	$('.tl').tooltip();
	$('.resize').autoResize({
	    // On resize:
	    onResize : function() {
	        $(this).css({opacity:0.8});
	    },
	    // After resize:
	    animateCallback : function() {
	        $(this).css({opacity:1});
	    },
	    // Quite slow animation:
	    animateDuration : 300,
	    // More extra space:
	    extraSpace : 1
	});
	
});	
	$('#transportation').focus(function(){ 
		
		if ($(this).html() == "input directions") {
		window.setTimeout(function() {
	        var sel, range;
	        if (window.getSelection && document.createRange) {
	            range = document.createRange();
	            range.selectNodeContents(document.getElementById("transportation"));
	            sel = window.getSelection();
	            sel.removeAllRanges();
	            sel.addRange(range);
	        } else if (document.body.createTextRange) {
	            range = document.body.createTextRange();
	            range.moveToElementText(document.getElementById("transportation"));
	            range.select();
	        }
	    }, 1);
		}
	});
	
	function clearTrans() {
		$('#MeetingPlace').hide(); $('#AddMeeting').show();
		
		$.ajax({
	        type: "POST",
	        url: "<%= plan_path(plan) %>",
	        data: "_method=PUT&plan[transportation]=",
	        success: function(msg){
				animateFlashMessage();
	        }
	     });
	}
	
	<%if params[:pop] == "yes"%>
	  
	   $(document).ready(function() {
		
	  	setTimeout('$("#attend").click();',1000);
	 });
	<%end%>
</SCRIPT>